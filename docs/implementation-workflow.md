# Forj.el Implementation Workflow

**Generated by**: `/sc:workflow` command  
**Strategy**: Systematic with MVP focus  
**Persona**: Emacs Lisp Architecture Specialist  
**Timeline**: 2-3 weeks for Phase 1 MVP

## Executive Summary

This workflow transforms the Forj.el PRD into a systematic, dependency-aware implementation plan. The approach prioritizes **forj-paren-checker** as the foundational validation system, followed by conversational AI interface and file system operations to create a Claude Code-style coding agent for Emacs Lisp development.

## Critical Path Analysis

### ðŸ”¥ **Blocking Dependencies (Must Complete First)**
1. **forj-paren-checker** â†’ ALL other functions depend on this
2. **Basic project structure** â†’ Required for TDD workflow
3. **Test framework setup** â†’ Required for all development

### âš¡ **Critical Path Sequence**
```
Project Setup (2 days) â†’ forj-paren-checker (3 days) â†’ Conversation System (4 days) â†’ File Operations (5 days) â†’ Integration & Testing (4 days)
```

## Phase 1: Foundation & Validation System (Days 1-5)

### Week 1, Days 1-2: Project Infrastructure
**Persona**: DevOps + Emacs Package Developer  
**Estimated Time**: 16 hours  
**Dependencies**: None (parallel work possible)

#### Tasks:
- [ ] **Initialize Emacs Package Structure** (4 hours)
  - Create proper package headers with metadata
  - Set up directory structure (`forj.el`, `test/`, `docs/`)
  - Configure `Package-Requires` dependencies
  - Add autoload cookies for interactive commands

- [ ] **ERT Test Framework Setup** (4 hours)
  - Create `test/forj-test.el` with basic test structure
  - Set up batch testing command for CI
  - Configure test discovery and organization patterns
  - Add test utilities and fixtures

- [ ] **Development Environment** (4 hours)
  - Set up Git hooks for validation
  - Configure Emacs development environment
  - Create testing and validation scripts
  - Set up `GEMINI_API_KEY` environment integration

- [ ] **Documentation Structure** (4 hours)
  - Finalize README with installation instructions
  - Complete API documentation stubs
  - Set up changelog and release notes template
  - Create contributor guidelines

#### Deliverables:
- âœ… Working Emacs package skeleton
- âœ… Functional test framework
- âœ… Development environment ready for TDD
- âœ… Basic documentation structure

#### Validation Criteria:
- [ ] Package loads without errors in Emacs
- [ ] Test framework runs successfully (even with 0 tests)
- [ ] All documentation is readable and accurate
- [ ] Git repository is properly configured

---

### Week 1, Days 3-5: Core Validation System
**Persona**: Language Processing Specialist + Quality Engineer  
**Estimated Time**: 24 hours  
**Dependencies**: Project infrastructure complete

#### **forj-paren-checker Implementation** (CRITICAL - BLOCKS ALL OTHER CODE)

##### Day 3: Test-Driven Foundation (8 hours)
- [ ] **Write Comprehensive Failing Tests** (4 hours)
  ```elisp
  (ert-deftest forj-test-paren-checker-balanced-code ()
    "Test that balanced code returns valid status."
    (should (eq 'valid (plist-get (forj-paren-check "(defun test ())") :status))))
  
  (ert-deftest forj-test-paren-checker-unmatched-paren ()
    "Test detection of unmatched parentheses."
    (let ((result (forj-paren-check "(defun test ()")))
      (should (eq 'invalid (plist-get result :status)))
      (should (= 1 (length (plist-get result :errors))))))
  ```

- [ ] **Error Detection Test Cases** (4 hours)
  - Test unmatched parentheses: `(`, `)`, `[`, `]`, `{`, `}`
  - Test nested structure validation
  - Test string literal handling: `"unclosed string`
  - Test comment handling: `; comment with (parens)`
  - Test escape sequence handling: `"string with \" quote"`

##### Day 4: Core Implementation (8 hours)
- [ ] **Basic Parser Implementation** (6 hours)
  ```elisp
  (defun forj-paren-check (code-string)
    "Analyze CODE-STRING for parentheses balance and syntax errors.
  Returns structured validation results."
    ;; Implementation with character-by-character parsing
    )
  ```

- [ ] **Structured Data Return** (2 hours)
  ```elisp
  ;; Success format:
  {:status 'valid :balanced t :message "Code is syntactically valid"}
  
  ;; Error format:
  {:status 'invalid :balanced nil 
   :errors [{:line 15 :column 23 :type 'unmatched-paren 
            :paren-type 'close-paren :expected ")" :found "}"
            :message "Unmatched closing brace, expected closing parenthesis"
            :suggestion "Replace '}' with ')' at line 15, column 23"}]
   :message "Found 1 syntax error"}
  ```

##### Day 5: Advanced Features & Integration (8 hours)
- [ ] **Context-Aware Parsing** (4 hours)
  - String literal state tracking
  - Comment state tracking  
  - Escape sequence handling
  - Multi-line structure support

- [ ] **AI Integration Features** (2 hours)
  - Machine-readable error codes
  - Recovery suggestions for common errors
  - Batch validation for multiple code snippets

- [ ] **Performance Optimization** (2 hours)
  - Single-pass parsing algorithm
  - Memory-efficient processing
  - Sub-millisecond validation for typical functions

#### Validation Criteria:
- [ ] **100% test coverage** for forj-paren-checker
- [ ] **All test cases pass** including edge cases
- [ ] **Performance target**: <1ms for functions under 1KB
- [ ] **Integration ready**: Returns structured, machine-readable data

---

## Phase 2: Conversational AI Interface (Days 6-10)

### Week 2, Days 1-3: Conversation System
**Persona**: UI/UX + Backend Integration Specialist  
**Estimated Time**: 24 hours  
**Dependencies**: forj-paren-checker completed and tested

#### **forj-conversation-buffer Implementation**

##### Day 6: Conversation Buffer Foundation (8 hours)
- [ ] **Write Failing Tests for Buffer Operations** (3 hours)
  ```elisp
  (ert-deftest forj-test-conversation-buffer-creation ()
    "Test that conversation buffer is created properly."
    (should (buffer-live-p (forj-create-conversation-buffer))))
  
  (ert-deftest forj-test-conversation-display-format ()
    "Test conversation message formatting."
    (should (string-match "ðŸ‘¤ You:" (forj-format-user-message "test"))))
  ```

- [ ] **Basic Buffer Implementation** (5 hours)
  - Create `*forj*` buffer with proper major mode
  - Implement message formatting and display
  - Add buffer navigation and interaction
  - **MANDATORY**: Validate all buffer code with forj-paren-checker

##### Day 7: Real-Time Activity System (8 hours)
- [ ] **Activity Tracking Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-activity-updates ()
    "Test real-time activity status updates."
    (forj-update-activity "Reading file...")
    (should (string-match "Reading file..." (forj-get-current-activity))))
  ```

- [ ] **Activity Display Implementation** (5 hours)
  - Real-time status indicators: "ðŸ¤” Analyzing...", "ðŸ“ Writing..."
  - Progress tracking for long operations
  - Success/error state visualization
  - **MANDATORY**: Validate activity tracking code with forj-paren-checker

##### Day 8: Conversation Persistence (8 hours)
- [ ] **Persistence Tests** (2 hours)
  - Test conversation history storage
  - Test session restore functionality

- [ ] **History Management Implementation** (6 hours)
  - Conversation data structure design
  - Session persistence across Emacs restarts
  - History search and navigation
  - **MANDATORY**: Validate persistence code with forj-paren-checker

#### Deliverables:
- âœ… Functional `*forj*` conversation buffer
- âœ… Real-time activity tracking system
- âœ… Conversation history management
- âœ… All code validated with forj-paren-checker

---

### Week 2, Days 4-5: AI Integration Layer
**Persona**: API Integration + Security Specialist  
**Estimated Time**: 16 hours  
**Dependencies**: Conversation system foundation complete

#### **forj-api-integration Implementation**

##### Day 9: Secure API Layer (8 hours)
- [ ] **API Security Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-api-key-retrieval ()
    "Test secure API key retrieval from environment."
    (should (stringp (forj-get-api-key))))
  
  (ert-deftest forj-test-api-request-format ()
    "Test proper API request structure."
    (should (plist-get (forj-build-api-request "test") :model)))
  ```

- [ ] **Gemini API Integration** (5 hours)
  - Environment variable API key retrieval (`GEMINI_API_KEY`)
  - JSON request/response handling
  - Error handling and timeouts
  - **MANDATORY**: Validate API code with forj-paren-checker

##### Day 10: Prompt Processing (8 hours)
- [ ] **Prompt Interface Tests** (2 hours)
  ```elisp
  (ert-deftest forj-test-prompt-command ()
    "Test interactive prompt command."
    (should (commandp 'forj-prompt)))
  ```

- [ ] **M-x forj-prompt Implementation** (6 hours)
  - Interactive command with minibuffer input
  - Context building from current buffer
  - Response processing and display
  - **MANDATORY**: Validate prompt code with forj-paren-checker

#### Deliverables:
- âœ… Secure Gemini API integration
- âœ… Working `M-x forj-prompt` command
- âœ… Basic conversation flow functional
- âœ… All API code validated with forj-paren-checker

---

## Phase 3: File System Operations (Days 11-15)

### Week 3, Days 1-3: File Operations Foundation
**Persona**: System Integration + Security Specialist  
**Estimated Time**: 24 hours  
**Dependencies**: API integration complete

#### **forj-file-operations Implementation**

##### Day 11: File Reading System (8 hours)
- [ ] **File Reader Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-file-reading ()
    "Test secure file content reading."
    (should (stringp (forj-read-file "test.el"))))
  
  (ert-deftest forj-test-permission-checks ()
    "Test file permission validation."
    (should-error (forj-read-file "/root/protected.el")))
  ```

- [ ] **Safe File Reading Implementation** (5 hours)
  - Permission and existence checking
  - Support for .el, .md, .txt files
  - Large file truncation/summarization
  - **MANDATORY**: Validate file reader code with forj-paren-checker

##### Day 12: File Writing System (8 hours)
- [ ] **File Writer Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-file-writing ()
    "Test safe file creation and modification."
    (forj-write-file "test.el" "(defun test ())")
    (should (file-exists-p "test.el")))
  
  (ert-deftest forj-test-elisp-validation ()
    "Test that .el files are validated before writing."
    (should-error (forj-write-file "bad.el" "(defun test (")))
  ```

- [ ] **Safe File Writing Implementation** (5 hours)
  - Backup creation before modification
  - Atomic file operations
  - **CRITICAL**: Use forj-paren-checker to validate ALL .el files before writing
  - Version control awareness

##### Day 13: Directory Context System (8 hours)
- [ ] **Directory Operation Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-directory-scanning ()
    "Test project directory analysis."
    (should (listp (forj-scan-directory "."))))
  ```

- [ ] **Project Context Implementation** (5 hours)
  - Current directory file tree scanning
  - Project type detection (elisp package, general project)
  - Context building for AI consumption
  - **MANDATORY**: Validate directory code with forj-paren-checker

#### Deliverables:
- âœ… Secure file reading system
- âœ… Safe file writing with elisp validation
- âœ… Project directory context system
- âœ… All file operations validated with forj-paren-checker

---

### Week 3, Days 4-5: Cross-Buffer Integration
**Persona**: Editor Integration + UX Specialist  
**Estimated Time**: 16 hours  
**Dependencies**: File operations complete

#### **forj-buffer-integration Implementation**

##### Day 14: Buffer Management (8 hours)
- [ ] **Buffer Management Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-cross-buffer-editing ()
    "Test editing files from conversation buffer."
    (should (bufferp (forj-open-file-from-conversation "test.el"))))
  ```

- [ ] **Multi-Buffer Operations** (5 hours)
  - Edit files from conversation commands
  - Seamless buffer switching
  - Track AI modifications across buffers
  - **MANDATORY**: Validate buffer management code with forj-paren-checker

##### Day 15: Smart Editing Integration (8 hours)
- [ ] **AI-Directed Editing Tests** (3 hours)
  ```elisp
  (ert-deftest forj-test-ai-code-application ()
    "Test applying AI suggestions to buffers."
    (should (forj-apply-ai-suggestions "buffer" "new-code")))
  ```

- [ ] **Smart Editing Implementation** (5 hours)
  - Apply AI suggestions directly to buffers
  - Diff previews before changes
  - Undo/redo support for AI modifications
  - **CRITICAL**: Use forj-paren-checker to validate ALL AI code before applying

#### Deliverables:
- âœ… Cross-buffer editing system
- âœ… AI-directed code application
- âœ… Smart editing with validation
- âœ… Complete buffer integration

---

## Phase 4: Integration & Quality Assurance (Days 16-18)

### Week 3, Days 6-7: System Integration
**Persona**: QA + Integration Specialist  
**Estimated Time**: 16 hours  
**Dependencies**: All core systems complete

#### **Full System Integration Testing**

##### Day 16: End-to-End Testing (8 hours)
- [ ] **Integration Test Suite** (4 hours)
  ```elisp
  (ert-deftest forj-test-full-workflow ()
    "Test complete user workflow from prompt to file modification."
    ;; Full conversation â†’ file analysis â†’ code generation â†’ application
    )
  ```

- [ ] **Performance Validation** (4 hours)
  - API response time testing (<3 seconds)
  - Memory usage profiling
  - Large file handling validation
  - Conversation buffer performance

##### Day 17: Quality Gates & Validation (8 hours)
- [ ] **Comprehensive Code Validation** (4 hours)
  - Run forj-paren-checker on ALL forj.el code
  - Fix any validation failures
  - Ensure 100% code quality compliance

- [ ] **User Experience Testing** (4 hours)
  - Manual testing of complete workflows
  - Error handling validation
  - Edge case verification
  - Documentation accuracy testing

#### Deliverables:
- âœ… Complete integration test suite
- âœ… Performance validation passed
- âœ… All code quality gates passed
- âœ… User experience validated

---

### Day 18: MVP Release Preparation
**Persona**: Release Manager + Documentation Specialist  
**Estimated Time**: 8 hours  
**Dependencies**: Integration testing complete

#### **Alpha Release Preparation**

- [ ] **Final Documentation Review** (2 hours)
  - Update README with accurate API documentation
  - Verify all installation instructions
  - Complete troubleshooting guide

- [ ] **Release Package Creation** (2 hours)
  - Create proper package headers
  - Verify MELPA compatibility
  - Generate release notes

- [ ] **Alpha Testing Preparation** (2 hours)
  - Create alpha testing checklist
  - Prepare feedback collection mechanisms
  - Set up issue tracking

- [ ] **Community Engagement Preparation** (2 hours)
  - Draft alpha announcement
  - Prepare demo materials
  - Set up support channels

#### Deliverables:
- âœ… Alpha release package ready
- âœ… Complete documentation
- âœ… Alpha testing framework
- âœ… Community engagement materials

---

## Parallel Work Streams

### Stream A: Core Development (Critical Path)
**Dependencies**: Sequential, cannot parallelize  
**Timeline**: Days 1-18  
**Resources**: 1 senior Emacs Lisp developer

1. Project Setup â†’ forj-paren-checker â†’ Conversation System â†’ File Operations â†’ Integration

### Stream B: Documentation & Community (Parallel)
**Dependencies**: Minimal  
**Timeline**: Days 1-18 (ongoing)  
**Resources**: 1 technical writer (part-time)

1. **Continuous Documentation Updates**
   - Keep README in sync with development
   - Update API documentation as features complete
   - Maintain changelog and release notes

2. **Community Preparation**
   - Alpha tester recruitment
   - Feedback mechanism setup
   - Demo material creation

### Stream C: Testing & QA (Parallel)
**Dependencies**: Follows development by 1-2 days  
**Timeline**: Days 3-18  
**Resources**: 1 QA engineer (part-time)

1. **Continuous Test Enhancement**
   - Expand test coverage as features develop
   - Performance testing and optimization
   - Edge case identification and testing

## Risk Analysis & Mitigation

### ðŸš¨ **High-Risk Items**

1. **forj-paren-checker Complexity**
   - **Risk**: Parser implementation more complex than estimated
   - **Mitigation**: Start with basic implementation, iterate with more features
   - **Contingency**: 2-day buffer built into schedule

2. **Gemini API Integration**
   - **Risk**: API changes, rate limits, or availability issues
   - **Mitigation**: Implement robust error handling and fallback mechanisms
   - **Contingency**: Mock API for development if needed

3. **File System Security**
   - **Risk**: Security vulnerabilities in file operations
   - **Mitigation**: Comprehensive permission checking and validation
   - **Contingency**: Restrict file operations to current directory only

### âš ï¸ **Medium-Risk Items**

1. **Cross-Buffer Complexity**
   - **Risk**: Emacs buffer management more complex than anticipated
   - **Mitigation**: Start with simple operations, iterate complexity
   - **Contingency**: Simplify to conversation-buffer-only for MVP

2. **Performance Requirements**
   - **Risk**: API response times exceed 3-second target
   - **Mitigation**: Implement caching and optimization strategies
   - **Contingency**: Adjust expectations, implement async operations

## Success Metrics

### **Phase 1 MVP Success Criteria**

#### **Functional Requirements**
- [ ] **forj-paren-checker**: 100% accurate validation of Emacs Lisp syntax
- [ ] **M-x forj-prompt**: Functional conversational interface
- [ ] **File Operations**: Read/write files safely with validation
- [ ] **Conversation Buffer**: Real-time AI interaction display
- [ ] **API Integration**: Secure Gemini API communication

#### **Quality Requirements**
- [ ] **Test Coverage**: >90% code coverage with ERT tests
- [ ] **Performance**: <3 second API response times
- [ ] **Security**: No API key exposure, secure file operations
- [ ] **Usability**: 100% keyboard-driven workflow

#### **Documentation Requirements**
- [ ] **Complete API Documentation**: All functions documented
- [ ] **User Guide**: Installation and usage instructions
- [ ] **Troubleshooting**: Common issues and solutions
- [ ] **Contributing**: Development setup and guidelines

## Post-MVP Roadmap Preview

### **Phase 2: Enhanced Features** (Weeks 4-6)
- Multi-file context understanding
- Advanced refactoring suggestions
- Shell command execution integration
- Performance optimization and caching

### **Phase 3: Community & Polish** (Weeks 7-8)
- MELPA package submission
- Community feedback integration
- Beta release preparation
- Documentation polish and examples

### **Future Enhancements**
- Multiple AI provider support
- Voice input integration
- Advanced debugging assistance
- Integration with popular Emacs packages

---

## Implementation Notes

### **Development Environment Setup**
```bash
# Required environment setup
export GEMINI_API_KEY="your-api-key-here"

# Testing command
emacs -batch -l ert -l test/forj-test.el -f ert-run-tests-batch-and-exit

# Development load command  
emacs -Q -l forj.el
```

### **Key Design Decisions**
1. **forj-paren-checker first**: All code must pass validation
2. **TDD mandatory**: No code without tests
3. **Security by design**: Environment-based API keys only  
4. **Emacs-native UX**: 100% keyboard-driven workflow
5. **Claude Code inspiration**: Conversation buffer with real-time activity

This workflow ensures systematic development of a robust, secure, and user-friendly AI coding agent for Emacs Lisp development, with forj-paren-checker as the foundational validation system protecting code quality throughout the development process.